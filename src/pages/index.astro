---
import { getChannels } from '../data/channels.js';
import MainLayout from '../layouts/MainLayout.astro';
import Carousel from '../components/Carousel.jsx';
import ChannelCard from '../components/ChannelCard.jsx';
import AnimeCard from '../components/AnimeCard.jsx';

import ComicCard from '../components/ComicCard.jsx';
import { animeService } from '../services/anime.js';

import { komikService } from '../services/komik.js';

const channels = await getChannels();

// Fetch additional content
let animeList = [];

let komikList = [];

try {
  const results = await Promise.allSettled([
    animeService.getOngoing(1),
    komikService.getRecommended('manga')
  ]);

  animeList = results[0].status === 'fulfilled' && Array.isArray(results[0].value) ? results[0].value.slice(0, 10) : [];
  komikList = results[1].status === 'fulfilled' && Array.isArray(results[1].value) ? results[1].value.slice(0, 10) : [];
} catch (e) {
  console.error('Error fetching home data:', e);
}

// Categorize channels for the UI sections
const indonesianChannels = channels.filter(c => c.country === 'ID' || c.group?.toLowerCase().includes('indonesia'));
const sportsChannels = channels.filter(c => /bola|sport|beIN|stadium|fox|espn/i.test(c.name) || /sport/i.test(c.group));
const featuredChannels = indonesianChannels.slice(0, 5);
---

<MainLayout title="Beranda">
	<div class="home-container">
		{featuredChannels.length > 0 && (
			<Carousel items={featuredChannels} client:load />
		)}

		<section class="channel-section">
			<div class="section-header">
				<h2 class="section-title">Populer di Indonesia</h2>
				<a href="/tv" class="see-all">Lihat Semua</a>
			</div>
			<div class="channel-grid">
				{indonesianChannels.slice(0, 12).map(channel => (
					<ChannelCard channel={channel} client:load />
				))}
			</div>
		</section>

		<section class="channel-section">
			<div class="section-header">
				<h2 class="section-title">Olahraga Terkini</h2>
				<a href="/live" class="see-all">Lihat Semua</a>
			</div>
			<div class="channel-grid">
				{sportsChannels.slice(0, 6).map(channel => (
					<ChannelCard channel={channel} client:load />
				))}
			</div>
		</section>

		{animeList.length > 0 && (
			<section class="channel-section">
				<div class="section-header">
					<h2 class="section-title">Anime Terbaru</h2>
					<a href="/anime" class="see-all">Lihat Semua</a>
				</div>
				<div class="horizontal-scroll">
					{animeList.map(anime => (
						<div class="horizontal-scroll__item">
							<AnimeCard anime={anime} client:load />
						</div>
					))}
				</div>
			</section>
		)}



		{komikList.length > 0 && (
			<section class="channel-section">
				<div class="section-header">
					<h2 class="section-title">Komik Pilihan</h2>
					<a href="/komik" class="see-all">Lihat Semua</a>
				</div>
				<div class="horizontal-scroll">
					{komikList.map(comic => (
						<div class="horizontal-scroll__item">
							<ComicCard comic={comic} client:load />
						</div>
					))}
				</div>
			</section>
		)}
	</div>
</MainLayout>

<style>
	.home-container {
		padding-top: 1rem;
	}

	.channel-section {
		margin-bottom: 3rem;
	}

	.section-header {
		display: flex;
		align-items: center;
		justify-content: space-between;
		margin-bottom: 1.5rem;
	}

	.section-title {
		font-family: 'Outfit', sans-serif;
		font-size: 1.5rem;
		font-weight: 700;
		color: white;
	}

	.see-all {
		color: #e11d48;
		text-decoration: none;
		font-weight: 600;
		font-size: 0.875rem;
		transition: opacity 0.2s ease;
	}

	.see-all:hover {
		opacity: 0.8;
	}

	.channel-grid {
		display: grid;
		grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
		gap: 1.5rem;
	}

	@media (max-width: 640px) {
		.channel-grid {
			grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
			gap: 1rem;
		}
		.section-title {
			font-size: 1.25rem;
		}
	}

	/* Reuse Horizontal Scroll Styles */
	.horizontal-scroll {
		display: flex;
		gap: 1rem;
		overflow-x: auto;
		padding-bottom: 1rem;
		scrollbar-width: none;
		-webkit-overflow-scrolling: touch;
	}

	.horizontal-scroll::-webkit-scrollbar {
		display: none;
	}

	.horizontal-scroll__item {
		flex: 0 0 140px;
	}

	@media (min-width: 768px) {
		.horizontal-scroll__item {
			flex: 0 0 160px;
		}
	}
</style>

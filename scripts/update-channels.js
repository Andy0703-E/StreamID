
import fetch from 'node-fetch'; // Requires node-fetch or Node 18+ global fetch
import fs from 'fs/promises';
import path from 'path';

// URLs
const CHANNELS_URL = 'https://iptv-org.github.io/api/channels.json';
const STREAMS_URL = 'https://iptv-org.github.io/api/streams.json';
const OUTPUT_FILE = path.resolve('src/data/channels.js');

async function updateChannels() {
    try {
        console.log('Fetching data...');
        const [channelsRes, streamsRes] = await Promise.all([
            fetch(CHANNELS_URL),
            fetch(STREAMS_URL)
        ]);

        const channels = await channelsRes.json();
        const streams = await streamsRes.json();

        console.log(`Loaded ${channels.length} channels and ${streams.length} streams.`);

        // 1. Filter Channels
        // - Country: ID
        // - Category: Sports (from any country, or just ID? User said "ambil hanya chanell indonesia dan live sportnya ambiil dari sini juga")
        // Interpretation: Take ALL Indonesia channels AND ALL Sport channels (globally or just relevant ones? Usually sport is global interest).
        // Let's include Global Sports + All Indonesia.

        const targetChannels = channels.filter(c => {
            const isIndo = c.country === 'ID';
            const isSport = c.categories && c.categories.includes('sports');
            return isIndo || isSport;
        });

        console.log(`Filtered down to ${targetChannels.length} potential channels.`);

        // 2. Map Streams to Channels
        // Create a lookup for streams by channel ID
        const streamsByChannel = {};
        streams.forEach(s => {
            if (!s.channel) return;
            if (!streamsByChannel[s.channel]) {
                streamsByChannel[s.channel] = [];
            }
            streamsByChannel[s.channel].push(s);
        });

        // 3. Build Final List
        const finalList = [];

        for (const channel of targetChannels) {
            const channelStreams = streamsByChannel[channel.id];
            if (!channelStreams || channelStreams.length === 0) continue;

            // Pick the best stream (e.g., https preferred, m3u8 preferred)
            // Sort priority: HTTPS > HTTP. 
            const bestStream = channelStreams.find(s => s.url.startsWith('https')) || channelStreams[0];

            finalList.push({
                id: channel.id,
                name: channel.name,
                logo: channel.logo,
                group: channel.categories && channel.categories.length > 0
                    ? (channel.categories.includes('sports') ? 'Sports' : 'National') // Simplify groups
                    : 'Other',
                country: channel.country,
                url: bestStream.url,
                website: channel.website
            });
        }

        console.log(`Final list has ${finalList.length} channels with streams.`);

        // 4. Write to file
        const fileContent = `
// Auto-generated by scripts/update-channels.js
// Do not edit manually if you plan to re-run the script.

export const FALLBACK_CHANNELS = ${JSON.stringify(finalList, null, 2)};

export async function getChannels() {
  return FALLBACK_CHANNELS;
}
`;

        await fs.writeFile(OUTPUT_FILE, fileContent, 'utf8');
        console.log(`Successfully wrote to ${OUTPUT_FILE}`);

    } catch (error) {
        console.error('Error updating channels:', error);
        process.exit(1);
    }
}

updateChannels();
